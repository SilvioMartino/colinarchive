<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Post — Colin Archive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="A quiet archive of essays, code, and notes – unfiltered and unpolished." />
  <meta property="og:title" content="Colin Archive" />
  <meta property="og:description" content="A quiet archive of essays, code, and notes – unfiltered and unpolished." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://yourdomain.com" />
  <meta property="og:image" content="https://yourdomain.com/og-image.jpg" />

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600&family=IBM+Plex+Mono:wght@400;500&family=Caveat:wght@400;600&family=Libre+Baskerville:wght@400;700&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg: #0d0d0d;
      --paper: #1a1a1a;
      --fg: #e8e8e8;
      --muted: #c0c0c0;
      --border: #2a2a2a;
      --highlight: #1f1f1f;
      --red: #ff6b6b;
      --dark-red: #b3002d;
      --blue: #4ecdc4;
      --green: #51cf66;
      --yellow: #ffe66d;
      --serif: 'Crimson Text', 'Georgia', serif;
      --mono: 'IBM Plex Mono', 'Courier New', monospace;
      --code: 'JetBrains Mono', 'IBM Plex Mono', monospace;
      --hand: 'Caveat', cursive;
      --essay-serif: 'Libre Baskerville', 'Georgia', serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--paper);
      color: var(--fg);
      font-family: var(--serif);
      min-height: 100vh;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* NAV */
    nav {
      background: rgba(26,26,26,0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 0 3rem;
      height: 56px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      transition: border-bottom-color 0.2s, box-shadow 0.2s;
    }
    nav.nav-type-essay { border-bottom: 2px solid var(--blue);   box-shadow: 0 1px 16px rgba(78,205,196,0.1); }
    nav.nav-type-code  { border-bottom: 2px solid var(--green);  box-shadow: 0 1px 16px rgba(81,207,102,0.1); }
    nav.nav-type-notes { border-bottom: 2px solid var(--yellow); box-shadow: 0 1px 16px rgba(255,230,109,0.1); }

    .nav-left { display: flex; align-items: center; gap: 1.25rem; }

    .logo {
      font-family: var(--mono);
      font-size: 0.7rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      font-weight: 500;
      text-decoration: none;
      color: var(--fg);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .logo-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--red);
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%,100% { opacity: 1; transform: scale(1); }
      50%      { opacity: 0.35; transform: scale(0.65); }
    }

    .post-type-label {
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 0.2rem 0.6rem;
      border: 1px solid currentColor;
      opacity: 0.7;
    }
    .post-type-label.essay  { font-family: var(--essay-serif); color: var(--blue); }
    .post-type-label.code   { font-family: var(--mono);        color: var(--green); }
    .post-type-label.notes  { font-family: var(--hand);        color: var(--yellow); }

    .nav-back {
      font-family: var(--mono);
      font-size: 0.6rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      text-decoration: none;
      transition: color 0.2s;
    }
    .nav-back:hover { color: var(--fg); }

    /* WRAPPER */
    .wrapper {
      width: 100%;
      margin: 60px 0;
      padding: 0 3rem;
    }

    .post-container {
      max-width: 900px;
      margin: 0 auto;
    }

    /* TITLE */
    .title {
      font-family: var(--serif);
      font-size: 2.5rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      line-height: 1.25;
    }
    .type-essay .title { font-family: var(--essay-serif); font-weight: 700; }
    .type-code  .title { font-family: var(--mono); letter-spacing: -0.02em; font-size: 2rem; }
    .type-notes .title { font-family: var(--hand); font-size: 2.2rem; }

    .meta {
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .meta-sep { opacity: 0.3; }

    .tags { margin-bottom: 2rem; }
    .tag {
      display: inline-block;
      border: 1px solid var(--border);
      padding: 0.25rem 0.7rem;
      margin: 0.2rem;
      font-family: var(--mono);
      font-size: 0.6rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: border-color 0.2s, color 0.2s;
    }
    .tag:hover { border-color: var(--blue); color: var(--blue); }

    /* BODY TEXT */
    .content {
      font-size: 1.18rem;
      line-height: 1.85;
      white-space: pre-wrap;
      color: var(--fg);
    }

    /* ── TERMINAL ── */
    .terminal {
      position: relative;
      border: 1px solid #222;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,0.7), inset 0 0 30px rgba(0,255,0,0.03);
    }

    .terminal-header {
      background: #181818;
      padding: 0.6rem 1rem;
      border-bottom: 1px solid #222;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: space-between;
    }
    .terminal-dots { display: flex; gap: 6px; align-items: center; }
    .terminal-dot {
      width: 12px; height: 12px;
      border-radius: 50%;
    }
    .terminal-dot:nth-child(1) { background: #ff5f56; box-shadow: 0 0 5px rgba(255,95,86,0.5); }
    .terminal-dot:nth-child(2) { background: #ffbd2e; box-shadow: 0 0 5px rgba(255,189,46,0.5); }
    .terminal-dot:nth-child(3) { background: #27c93f; box-shadow: 0 0 5px rgba(39,201,63,0.5); }

    .terminal-title {
      font-family: var(--code);
      font-size: 0.58rem;
      color: #555;
      letter-spacing: 0.08em;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .terminal-title i { font-size: 0.55rem; color: #3a5a3a; }

    /* Copy button */
    .copy-btn {
      background: transparent;
      border: 1px solid #333;
      border-radius: 3px;
      color: #3a6a3a;
      font-family: var(--code);
      font-size: 0.55rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 0.25rem 0.65rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.35rem;
      transition: background 0.2s, border-color 0.2s, color 0.2s;
    }
    .copy-btn:hover  { background: rgba(39,201,63,0.06); border-color: #3a6a3a; color: #51cf66; }
    .copy-btn.copied { background: rgba(39,201,63,0.1);  border-color: #51cf66; color: #7fffaa; }
    .copy-btn i { font-size: 0.6rem; }

    /* Code body — single scrollable div, rows keep number+code together */
    .terminal-body {
      background: #0a0a0a;
      overflow-x: auto;
      overflow-y: visible;
    }
    .terminal-body::-webkit-scrollbar { height: 5px; }
    .terminal-body::-webkit-scrollbar-track { background: #0a0a0a; }
    .terminal-body::-webkit-scrollbar-thumb { background: #2a2a2a; border-radius: 3px; }

    /* Each row = number cell + code cell — they cannot drift */
    .code-row {
      display: flex;
      align-items: flex-start;
    }
    .code-row:first-child { padding-top: 1rem; }
    .code-row:last-child  { padding-bottom: 1rem; }
    .code-row:hover .ln   { color: #4a8a4a; }
    .code-row:hover .code-line { background: rgba(0,255,0,0.015); }

    .ln {
      flex-shrink: 0;
      width: 50px;
      text-align: right;
      padding: 0 0.8rem 0 0;
      font-family: var(--code);
      font-size: 0.8rem;
      font-weight: 300;
      line-height: 1.65;
      color: #2e4a2e;
      background: #080808;
      border-right: 1px solid #1a1a1a;
      user-select: none;
      transition: color 0.1s;
    }

    .code-line {
      flex: 1;
      padding: 0 1.25rem;
      font-family: var(--code);
      font-size: 0.82rem;
      font-weight: 400;
      line-height: 1.65;
      white-space: pre;
      color: #9ecb9e;
      letter-spacing: 0.01em;
      transition: background 0.1s;
    }

    /* Syntax tokens */
    .tok-kw  { color: #5fd4bc; font-weight: 500; }
    .tok-str { color: #88d4ab; }
    .tok-num { color: #c8e87a; }
    .tok-cmt { color: #3d5c42; font-style: italic; }
    .tok-fn  { color: #a8d888; }

    /* Blinking cursor on last line */
    .term-cursor {
      display: inline-block;
      width: 7px; height: 0.85em;
      background: #4dcc6a;
      vertical-align: text-bottom;
      margin-left: 1px;
      animation: cur 1.1s step-end infinite;
      box-shadow: 0 0 5px #4dcc6a;
    }
    @keyframes cur { 0%,50%{opacity:1} 51%,100%{opacity:0} }

    /* Status bar */
    .terminal-footer {
      background: #111;
      border-top: 1px solid #1e1e1e;
      padding: 0.3rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .term-status {
      font-family: var(--code);
      font-size: 0.5rem;
      font-weight: 300;
      letter-spacing: 0.08em;
      color: #2e4a2e;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .term-status-ok { color: #3a6a3a; }
    .term-status-dot {
      width: 5px; height: 5px;
      border-radius: 50%;
      background: #4dcc6a;
      box-shadow: 0 0 4px #4dcc6a;
      animation: blink-s 3s ease-in-out infinite;
    }
    @keyframes blink-s { 0%,80%,100%{opacity:1} 90%{opacity:0.2} }

    /* LOCKED */
    .locked-message {
      text-align: center;
      padding: 2.5rem 2rem;
      border: 1px solid rgba(255,107,107,0.3);
      margin-top: 2rem;
      background: repeating-linear-gradient(
        -45deg,
        rgba(179,0,45,0.06) 0px, rgba(179,0,45,0.06) 8px,
        transparent 8px, transparent 18px
      );
      position: relative;
    }
    .locked-message h3 {
      font-family: var(--mono);
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      color: var(--red);
      margin-bottom: 0.75rem;
      text-transform: uppercase;
    }
    .locked-message p { color: var(--muted); margin-bottom: 1.5rem; }
    .btn {
      display: inline-block;
      padding: 0.65rem 1.5rem;
      background: transparent;
      border: 1px solid var(--red);
      color: var(--red);
      font-family: var(--mono);
      font-size: 0.65rem;
      letter-spacing: 0.1em;
      text-decoration: none;
      text-transform: uppercase;
      transition: background 0.2s, color 0.2s;
    }
    .btn:hover { background: var(--red); color: var(--bg); }

    .locked-icon {
      position: absolute;
      top: 1rem; right: 1rem;
      font-size: 1.75rem;
      color: rgba(255,255,255,0.5);
      pointer-events: none;
    }

    .loading {
      text-align: center;
      font-family: var(--mono);
      color: var(--muted);
      padding: 4rem;
      font-size: 0.8rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    @media (max-width: 700px) {
      nav { padding: 0 1.5rem; }
      .wrapper { padding: 0 1.25rem; margin: 40px 0; }
      .title { font-size: 1.9rem; }
      .type-code .title { font-size: 1.5rem; }
      .type-notes .title { font-size: 1.8rem; }
      .terminal-footer { display: none; }
      .ln { width: 36px; font-size: 0.7rem; }
      .code-line { font-size: 0.72rem; }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body>

<nav id="mainNav">
  <div class="nav-left">
    <a href="/" class="logo"><span class="logo-dot"></span>Colin Archive</a>
    <span class="post-type-label" id="postTypeLabel"></span>
  </div>
  <a href="/" class="nav-back">← Back</a>
</nav>

<div class="wrapper">
  <div class="post-container" id="postContainer">
    <div class="loading">Loading post...</div>
  </div>
</div>

<script>
  const SUPABASE_URL = "https://lbpkgvmxxcubzbzwoswd.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxicGtndm14eGN1Ynpiendvc3dkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNzM2OTQsImV4cCI6MjA4Njg0OTY5NH0.BaP0JY9v74qJPu9qRYoL1Mn3NWM3I-VB51dczOvxnrI";

  const db        = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  const nav       = document.getElementById('mainNav');
  const typeLabel = document.getElementById('postTypeLabel');
  const container = document.getElementById('postContainer');

  function getPostId() {
    return new URLSearchParams(location.search).get("id");
  }

  function escapeHtml(s) {
    if (!s) return '';
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }

  function normalizeIndent(text) {
    const lines = text.split('\n');
    let min = Infinity;
    lines.forEach(l => { if (l.trim()) { const m = l.match(/^(\s*)/); min = Math.min(min, m[0].length); } });
    if (min === Infinity) min = 0;
    return lines.map(l => l.slice(min)).join('\n');
  }

  function highlight(line) {
    let s = line;
    s = s.replace(/^([ \t]*)(\/\/.*|#.*)$/, '$1<span class="tok-cmt">$2</span>');
    s = s.replace(/(&quot;(?:[^&]|&(?!quot;))*&quot;|&#039;(?:[^&]|&(?!#039;))*&#039;|`[^`]*`)/g, '<span class="tok-str">$1</span>');
    s = s.replace(/\b(const|let|var|function|return|if|else|for|while|do|switch|case|break|continue|class|new|import|export|default|from|async|await|try|catch|finally|throw|typeof|instanceof|void|delete|in|of|true|false|null|undefined|this|super|extends|static|get|set|def|print|pass|and|or|not|with|as|yield|lambda|elif|except|raise|global|nonlocal)\b/g, '<span class="tok-kw">$1</span>');
    s = s.replace(/\b(\d+\.?\d*)\b/g, '<span class="tok-num">$1</span>');
    s = s.replace(/\b([a-zA-Z_]\w*)(?=\s*\()/g, '<span class="tok-fn">$1</span>');
    return s;
  }

  async function loadPost() {
    const id = getPostId();
    if (!id) { container.innerHTML = "<div class='loading'>No post ID specified</div>"; return; }
    const { data, error } = await db.from("posts").select("*").eq("id", id).single();
    if (error || !data) { container.innerHTML = "<div class='loading'>Post not found</div>"; return; }
    renderPost(data);
  }

  function renderPost(post) {
    const type   = post.type || 'essay';
    const isPaid = post.access === 'paid';
    const date   = new Date(post.created_at).toLocaleDateString();
    const rt     = post.readtime || 1;
    const tags   = (post.tags || '').split(',').filter(Boolean)
                    .map(t => `<span class="tag">${escapeHtml(t.trim())}</span>`).join('');
    const label  = type === 'code' ? 'code' : type === 'notes' ? 'note' : 'essay';

    nav.className = '';
    nav.classList.add(`nav-type-${type}`);
    typeLabel.className = `post-type-label ${type}`;
    typeLabel.textContent = label;

    const metaHtml = `<div class="meta">${date}<span class="meta-sep">·</span>${rt} min read</div>`;
    const tagsHtml = tags ? `<div class="tags">${tags}</div>` : '';

    let contentHtml;

    if (isPaid) {
      contentHtml = `
        <h1 class="title">${escapeHtml(post.title)}</h1>
        ${metaHtml}${tagsHtml}
        <div class="locked-message">
          <i class="fas fa-lock locked-icon"></i>
          <h3>Paid Entry</h3>
          <p>This post requires access.</p>
          <a class="btn" href="#">Unlock</a>
        </div>`;

    } else if (type === 'code') {
      const raw   = normalizeIndent(post.content || '');
      const lines = raw.split('\n');
      while (lines.length && !lines[lines.length - 1].trim()) lines.pop();

      // Each row holds ln + code in the same flex container — they cannot drift
      const rowsHtml = lines.map((line, i) => {
        const esc  = escapeHtml(line);
        const code = highlight(esc);
        const cur  = i === lines.length - 1 ? '<span class="term-cursor"></span>' : '';
        return `<div class="code-row"><span class="ln">${i + 1}</span><span class="code-line">${code}${cur}</span></div>`;
      }).join('');

      contentHtml = `
        <h1 class="title">${escapeHtml(post.title)}</h1>
        ${metaHtml}${tagsHtml}
        <div class="terminal">
          <div class="terminal-header">
            <div class="terminal-dots">
              <span class="terminal-dot"></span>
              <span class="terminal-dot"></span>
              <span class="terminal-dot"></span>
            </div>
            <div class="terminal-title"><i class="fas fa-code"></i>${escapeHtml(post.title)}</div>
            <button class="copy-btn" id="copyCodeBtn"><i class="far fa-copy"></i> Copy</button>
          </div>
          <div class="terminal-body">${rowsHtml}</div>
          <div class="terminal-footer">
            <div class="term-status">
              <span class="term-status-dot"></span>
              <span class="term-status-ok">No errors</span>
              <span>${lines.length} lines</span>
            </div>
            <div class="term-status">
              <span>UTF-8</span>
            </div>
          </div>
        </div>`;

    } else {
      contentHtml = `
        <h1 class="title">${escapeHtml(post.title)}</h1>
        ${metaHtml}${tagsHtml}
        <div class="content">${escapeHtml(post.content || '')}</div>`;
    }

    container.innerHTML = `<div class="type-${type}">${contentHtml}</div>`;

    if (type === 'code' && !isPaid) {
      const btn = document.getElementById('copyCodeBtn');
      if (btn) {
        const raw = normalizeIndent(post.content || '');
        btn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(raw);
            btn.classList.add('copied');
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => { btn.classList.remove('copied'); btn.innerHTML = '<i class="far fa-copy"></i> Copy'; }, 2000);
          } catch(e) { console.error(e); }
        });
      }
    }
  }

  loadPost();
</script>

</body>
</html>
